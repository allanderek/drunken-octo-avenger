// Generated by CoffeeScript 1.8.0
(function() {
  var persona, tesuji_charm;

  if (window.tesuji_charm == null) {
    window.tesuji_charm = {};
  }

  tesuji_charm = window.tesuji_charm;

  if (tesuji_charm.persona == null) {
    tesuji_charm.persona = {};
  }

  persona = tesuji_charm.persona;

  persona.initialize = function(navigator) {
    var logged_in_user, signin_link, signout_link;
    signin_link = $('#persona_login');
    if (signin_link.length > 0) {
      signin_link.click(function() {
        return navigator.id.request();
      });
    }
    signout_link = $('#logout');
    if (signout_link.length > 0) {
      signout_link.click(function() {
        return navigator.id.logout();
      });
    }
    logged_in_user = tesuji_charm.current_persona_email;
    if (logged_in_user === '') {
      logged_in_user = null;
    }
    return navigator.id.watch({
      loggedInUser: logged_in_user,
      onlogin: function(assertion) {
        return $.ajax({
          type: 'POST',
          url: '/persona/login',
          data: {
            assertion: assertion
          },
          success: function(res, status, xhr) {
            return window.location.reload();
          },
          error: function(xhr, status, err) {
            return navigator.id.logout();
          }
        });
      },
      onlogout: function() {
        return $.ajax({
          type: 'POST',
          url: '/logout',
          success: function(res, status, xhr) {
            return window.location.reload();
          },
          error: function(xhr, status, err) {
            return void 0;
          }
        });
      }
    });
  };

}).call(this);
