// Generated by CoffeeScript 1.9.0
(function() {
  var persona, tesuji_charm;

  if (window.tesuji_charm == null) {
    window.tesuji_charm = {};
  }

  tesuji_charm = window.tesuji_charm;

  if (tesuji_charm.persona == null) {
    tesuji_charm.persona = {};
  }

  persona = tesuji_charm.persona;

  persona.initialize = function(navigator) {
    var loggedInUser, signinLink, signoutLink;
    signinLink = $('#persona_login');
    if (signinLink.length > 0) {
      signinLink.click(function() {
        return navigator.id.request();
      });
    }
    signoutLink = $('#logout');
    if (signoutLink.length > 0) {
      signoutLink.click(function() {
        return navigator.id.logout();
      });
    }
    loggedInUser = tesuji_charm.currentPersonaEmail;
    if (loggedInUser === '') {
      loggedInUser = null;
    }
    return navigator.id.watch({
      loggedInUser: loggedInUser,
      onlogin: function(assertion) {
        return $.ajax({
          type: 'POST',
          url: '/persona/login',
          data: {
            assertion: assertion
          },
          success: function(res, status, xhr) {
            return window.location.reload();
          },
          error: function(xhr, status, err) {
            return navigator.id.logout();
          }
        });
      },
      onlogout: function() {
        return $.ajax({
          type: 'POST',
          url: '/logout',
          success: function(res, status, xhr) {
            return window.location.reload();
          },
          error: function(xhr, status, err) {
            return void 0;
          }
        });
      }
    });
  };

}).call(this);
